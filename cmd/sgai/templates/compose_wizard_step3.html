<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="color-scheme" content="light">
	<title>GOAL.md Composer - Step {{.Step}} - {{.DirName}}</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
	<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js" integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/idiomorph@0.3.0/dist/idiomorph-ext.min.js"></script>
	<style>
		html, body { height: 100%; margin: 0; }
		body { display: flex; flex-direction: column; }
		main.container-fluid { flex: 1; display: flex; flex-direction: column; padding: 1rem; overflow: hidden; }
		.wizard-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--pico-muted-border-color); }
		.wizard-header nav ul { margin: 0; }
		.progress-indicator { display: flex; gap: 0.5rem; align-items: center; }
		.progress-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--pico-muted-border-color); }
		.progress-dot.active { background-color: var(--pico-primary); }
		.progress-dot.completed { background-color: var(--pico-primary); opacity: 0.6; }
		.wizard-layout { display: grid; grid-template-columns: 60% 40%; gap: 1.5rem; flex: 1; overflow: hidden; }
		.wizard-content { display: flex; flex-direction: column; overflow-y: auto; padding-right: 0.5rem; }
		.wizard-step { flex: 1; }
		.wizard-step h2 { margin-bottom: 0.5rem; }
		.wizard-step p.hint { color: var(--pico-muted-color); margin-bottom: 1.5rem; }
		.wizard-navigation { display: flex; justify-content: space-between; padding-top: 1rem; border-top: 1px solid var(--pico-muted-border-color); margin-top: auto; }
		.wizard-navigation button, .wizard-navigation a[role="button"] { margin: 0; }
		.preview-container { position: sticky; top: 0; align-self: start; max-height: calc(100vh - 150px); overflow-y: auto; border: 1px solid var(--pico-muted-border-color); border-radius: 0.5rem; background: var(--pico-card-background-color); }
		.preview-header { position: sticky; top: 0; background: var(--pico-card-background-color); padding: 1rem; border-bottom: 1px solid var(--pico-muted-border-color); z-index: 10; }
		.preview-header h3 { margin: 0; font-size: 1rem; }
		.preview-body { padding: 1rem; }
		.preview-content { font-size: 0.9rem; line-height: 1.6; overflow-wrap: break-word; word-break: break-word; }
		.flow-error { margin-top: 1rem; padding: 0.5rem; background: color-mix(in srgb, #ef4444 15%, transparent); color: #991b1b; border-left: 3px solid #ef4444; border-radius: 0.25rem; font-size: 0.85rem; }
		.wizard-navigation a[role="button"], .wizard-navigation button { min-width: 120px; text-align: center; }
		.toggle-option { display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border: 1px solid var(--pico-muted-border-color); border-radius: 0.5rem; margin-bottom: 1rem; }
		.toggle-option label { font-weight: 600; margin: 0; }
		.toggle-option p { font-size: 0.85rem; color: var(--pico-muted-color); margin: 0.25rem 0 0 0; }
		.toggle-option input[type="checkbox"] { margin: 0; }
		.info-box { padding: 1rem; background: color-mix(in srgb, var(--pico-primary) 10%, transparent); border-radius: 0.5rem; margin-top: 1rem; }
		@media (max-width: 768px) { .wizard-layout { grid-template-columns: 1fr; } .preview-container { max-height: none; } }
	</style>
</head>
<body hx-ext="morph">
	<main class="container-fluid">
		<div class="wizard-header">
			<nav>
				<ul>
					<li><a href="/compose?workspace={{.DirName}}">‚Üê Back to Templates</a></li>
				</ul>
			</nav>
			<div class="progress-indicator">
				{{range $i := seq 1 4}}
				<div class="progress-dot {{if lt $i $.Step}}completed{{else if eq $i $.Step}}active{{end}}"></div>
				{{end}}
			</div>
		</div>

		<div class="wizard-layout">
			<div class="wizard-content">
				<div class="wizard-step">
					<h2>Step 3: Safety Analysis</h2>
					<p class="hint">Enable STPA (System Theoretic Process Analysis) for hazard analysis and safety-critical systems.</p>

					<form hx-post="/compose/wizard/step/3?workspace={{.DirName}}"
					      hx-target="#compose-preview"
					      hx-swap="morph:innerHTML"
					      hx-trigger="change">
						<div class="toggle-option">
							<div>
								<label>Enable Safety Analysis</label>
								<p>STPA analyst will identify unsafe control actions and loss scenarios</p>
							</div>
							<input type="checkbox" 
								name="safetyanalysis" 
								value="yes"
								role="switch"
								{{if .Wizard.SafetyAnalysis}}checked{{end}}>
						</div>
					</form>

					{{if .Wizard.SafetyAnalysis}}
					<div class="info-box">
						<strong>What STPA provides:</strong>
						<ul style="margin: 0.5rem 0 0 0;">
							<li>Loss identification</li>
							<li>Hazard analysis</li>
							<li>Unsafe control action detection</li>
							<li>Loss scenario modeling</li>
						</ul>
					</div>
					{{end}}
				</div>

				<div class="wizard-navigation">
					<a href="/compose/wizard/step/2?workspace={{.DirName}}" role="button" class="secondary outline">‚Üê Back</a>
					<a href="/compose/wizard/step/4?workspace={{.DirName}}" role="button">Next ‚Üí</a>
				</div>

			</div>

			<div class="preview-container" id="compose-preview">
				<div class="preview-header">
					<h3>üìÑ GOAL.md Preview</h3>
				</div>
				<div class="preview-body">
					<div class="preview-content">
						{{.Preview}}
					</div>
					{{if .FlowError}}
					<div class="flow-error">
						‚ö†Ô∏è {{.FlowError}}
					</div>
					{{end}}
				</div>
			</div>
		</div>
	</main>

	<script>
		Idiomorph.defaults.ignoreActive = true;
		Idiomorph.defaults.ignoreActiveValue = true;
	</script>
</body>
</html>
